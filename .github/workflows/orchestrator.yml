name: Issue Orchestrator

# æ”¯æŒä¸‰ç§è§¦å‘æ–¹å¼ï¼š@mentionã€/commandã€æ ‡ç­¾å˜æ›´
on:
  issue_comment:
    types: [created, edited]
  issues:
    types: [labeled]

# å¹¶å‘æ§åˆ¶ï¼šå…è®¸å¤šä¸ªè§¦å‘å…±å­˜ï¼Œæ¯ä¸ªè§¦å‘ç‹¬ç«‹è¿è¡Œ
concurrency:
  group: ${{ github.event.issue.number }}-${{ github.run_id }}
  cancel-in-progress: false

permissions:
  issues: write
  contents: read

jobs:
  # ========== æ ‡ç­¾è§¦å‘ï¼šstate:ready-for-review ==========
  auto-trigger-review:
    if: github.event_name == 'issues' &&
        github.event.action == 'labeled' &&
        github.event.label.name == 'state:ready-for-review' &&
        github.event.issue.state == 'open'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
          prune-cache: false
      - run: uv sync --extra video

      - name: Update issue state
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "state:review" \
            --remove-label "state:ready-for-review" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Run full review process
        run: |
          echo "Running review flow..."
          uv run python -m issuelab review \
            --issue ${{ github.event.issue.number }} \
            --post
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          MINIMAX_API_KEY: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
          LOG_FILE: ${{ github.workspace }}/logs/auto_review_${{ github.event.issue.number }}.log
          LOG_LEVEL: DEBUG
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "30000"
          ACTIONS_STEP_DEBUG: "true"
          ACTIONS_RUNNER_DEBUG: "true"

      - name: Mark needs summary
        if: always()
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:needs-summary" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - uses: actions/upload-artifact@v4
        with:
          name: auto-review-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  # ========== @mention è§¦å‘ï¼šæ£€æµ‹å¹¶åˆ†å‘ ==========
  detect-mentions:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.state == 'open' &&
      !contains(github.event.comment.body, '[Agent:') &&
      (contains(github.event.comment.body, 'ç›¸å…³äººå‘˜:') || contains(github.event.comment.body, 'åä½œè¯·æ±‚:'))
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      agents: ${{ steps.detect.outputs.agents }}
      has_system: ${{ steps.detect.outputs.has_system }}

    steps:
      - uses: actions/checkout@v4

      - name: Detect system agents
        id: detect
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          FOUND_AGENTS=$(python - <<'PY'
          import os
          import re
          from pathlib import Path

          comment = os.environ.get("COMMENT_BODY", "")
          agents_dir = Path("agents")

          system_agents: set[str] = set()
          if agents_dir.exists():
            for agent_file in sorted(agents_dir.glob("*/agent.yml")):
              try:
                text = agent_file.read_text(encoding="utf-8")
              except OSError:
                continue

              if re.search(r"^\s*enabled:\s*false\s*$", text, re.IGNORECASE | re.MULTILINE):
                continue

              type_match = re.search(
                r"^\s*agent_type:\s*['\"]?([a-zA-Z_]+)['\"]?\s*$",
                text,
                re.IGNORECASE | re.MULTILINE,
              )
              if not type_match or type_match.group(1).strip().lower() != "system":
                continue

              owner_match = re.search(
                r"^\s*(?:owner|username):\s*['\"]?([a-zA-Z0-9_.-]+)['\"]?\s*$",
                text,
                re.IGNORECASE | re.MULTILINE,
              )
              if not owner_match:
                continue
              system_agents.add(owner_match.group(1).strip().lower())

          found: list[str] = []
          controlled_lines: list[str] = []
          in_list_section = False
          for raw_line in comment.splitlines():
            line = raw_line.strip()
            if "ç›¸å…³äººå‘˜:" in line:
              controlled_lines.append(line.split("ç›¸å…³äººå‘˜:", 1)[1])
              in_list_section = False
              continue
            if line.startswith("åä½œè¯·æ±‚:"):
              in_list_section = True
              continue
            if in_list_section:
              if re.match(r"^\s*-\s+@", raw_line):
                controlled_lines.append(raw_line)
                continue
              if line and not line.startswith("-"):
                in_list_section = False

          controlled_text = "\n".join(controlled_lines)
          for mention in re.findall(r"@([a-zA-Z0-9_-]+)", controlled_text):
            candidate = mention.lower()
            if candidate in system_agents and candidate not in found:
              found.append(candidate)

          print(",".join(found), end="")
          PY
          )

          if [ -n "$FOUND_AGENTS" ]; then
            echo "has_system=true" >> $GITHUB_OUTPUT
            echo "agents=$FOUND_AGENTS" >> $GITHUB_OUTPUT
            echo "Found system agents: $FOUND_AGENTS"
          else
            echo "has_system=false" >> $GITHUB_OUTPUT
            echo "No system agents found"
          fi

  # ========== è¿è¡Œç³»ç»Ÿ Agentï¼ˆå¹¶è¡Œ Jobï¼‰ ==========
  run-moderator:
    needs: detect-mentions
    if: needs.detect-mentions.outputs.has_system == 'true' && contains(needs.detect-mentions.outputs.agents, 'moderator')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync
      - uses: ./.github/actions/run-agent
        with:
          agent-name: moderator
          issue-number: ${{ github.event.issue.number }}
          gh-token: ${{ secrets.PAT_TOKEN }}
          anthropic-auth-token: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          anthropic-base-url: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          anthropic-model: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
      - uses: actions/upload-artifact@v4
        with:
          name: moderator-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  run-reviewer_a:
    needs: detect-mentions
    if: needs.detect-mentions.outputs.has_system == 'true' && contains(needs.detect-mentions.outputs.agents, 'reviewer_a')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync
      - uses: ./.github/actions/run-agent
        with:
          agent-name: reviewer_a
          issue-number: ${{ github.event.issue.number }}
          gh-token: ${{ secrets.PAT_TOKEN }}
          anthropic-auth-token: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          anthropic-base-url: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          anthropic-model: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
      - uses: actions/upload-artifact@v4
        with:
          name: reviewer-a-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  run-reviewer_b:
    needs: detect-mentions
    if: needs.detect-mentions.outputs.has_system == 'true' && contains(needs.detect-mentions.outputs.agents, 'reviewer_b')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync
      - uses: ./.github/actions/run-agent
        with:
          agent-name: reviewer_b
          issue-number: ${{ github.event.issue.number }}
          gh-token: ${{ secrets.PAT_TOKEN }}
          anthropic-auth-token: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          anthropic-base-url: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          anthropic-model: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
      - uses: actions/upload-artifact@v4
        with:
          name: reviewer-b-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  run-summarizer:
    needs: detect-mentions
    if: needs.detect-mentions.outputs.has_system == 'true' && contains(needs.detect-mentions.outputs.agents, 'summarizer')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync
      - uses: ./.github/actions/run-agent
        with:
          agent-name: summarizer
          issue-number: ${{ github.event.issue.number }}
          gh-token: ${{ secrets.PAT_TOKEN }}
          anthropic-auth-token: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          anthropic-base-url: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          anthropic-model: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}

      - name: Check for auto-close
        if: always()
        run: |
          LAST_COMMENT=$(gh issue comments ${{ github.event.issue.number }} --repo ${{ github.repository }} --limit 1 --json body -q '.[0].body' 2>/dev/null || echo "")
          if echo "$LAST_COMMENT" | grep -q '\[CLOSE\]'; then
            echo "[INFO] æ£€æµ‹åˆ° [CLOSE] æ ‡è®°ï¼Œæ­£åœ¨å…³é—­ Issue..."
            gh issue close ${{ github.event.issue.number }} --repo ${{ github.repository }} --reason "completed"
            echo "[OK] Issue å·²è‡ªåŠ¨å…³é—­"
          else
            echo "[INFO] æœªæ£€æµ‹åˆ° [CLOSE] æ ‡è®°ï¼Œä¸è‡ªåŠ¨å…³é—­"
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - uses: actions/upload-artifact@v4
        with:
          name: summarizer-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  run-pubmed-observer:
    needs: detect-mentions
    if: needs.detect-mentions.outputs.has_system == 'true' && contains(needs.detect-mentions.outputs.agents, 'pubmed_observer')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync
      - uses: ./.github/actions/run-agent
        with:
          agent-name: pubmed_observer
          issue-number: ${{ github.event.issue.number }}
          gh-token: ${{ secrets.PAT_TOKEN }}
          anthropic-auth-token: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          anthropic-base-url: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          anthropic-model: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
      - uses: actions/upload-artifact@v4
        with:
          name: pubmed-observer-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  run-arxiv-observer:
    needs: detect-mentions
    if: needs.detect-mentions.outputs.has_system == 'true' && contains(needs.detect-mentions.outputs.agents, 'arxiv_observer')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync
      - uses: ./.github/actions/run-agent
        with:
          agent-name: arxiv_observer
          issue-number: ${{ github.event.issue.number }}
          gh-token: ${{ secrets.PAT_TOKEN }}
          anthropic-auth-token: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          anthropic-base-url: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          anthropic-model: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
      - uses: actions/upload-artifact@v4
        with:
          name: arxiv-observer-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  run-observer:
    needs: detect-mentions
    if: needs.detect-mentions.outputs.has_system == 'true' && contains(needs.detect-mentions.outputs.agents, 'observer')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync
      - uses: ./.github/actions/run-agent
        with:
          agent-name: observer
          issue-number: ${{ github.event.issue.number }}
          gh-token: ${{ secrets.PAT_TOKEN }}
          anthropic-auth-token: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          anthropic-base-url: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          anthropic-model: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
      - uses: actions/upload-artifact@v4
        with:
          name: observer-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  run-video-manim:
    needs: detect-mentions
    if: needs.detect-mentions.outputs.has_system == 'true' && contains(needs.detect-mentions.outputs.agents, 'video_manim')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync

      - name: Install manim runtime dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libcairo2-dev libpango1.0-dev pkg-config

      - name: Run video_manim agent
        run: |
          mkdir -p outputs/manim
          uv run python -m issuelab execute \
            --issue ${{ github.event.issue.number }} \
            --agents video_manim \
            --post
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
          LOG_FILE: ${{ github.workspace }}/logs/video_manim_${{ github.event.issue.number }}.log
          LOG_LEVEL: DEBUG
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "30000"
          ACTIONS_STEP_DEBUG: "true"
          ACTIONS_RUNNER_DEBUG: "true"
          MCP_LOG_DETAIL: "1"
          PROMPT_LOG: "1"
          ISSUELAB_TRIGGER_COMMENT: ${{ github.event.comment.body }}

      - name: Upload video outputs
        run: |
          echo "[INFO] Listing candidate output directories"
          ls -la agents/video_manim/outputs 2>/dev/null || true
          ls -la agents/video_manim/media/videos 2>/dev/null || true
          ls -la outputs 2>/dev/null || true
          ls -la media/videos 2>/dev/null || true
          find agents/video_manim -type f -name "*.mp4" 2>/dev/null | head -20 || true
          find . -type f -name "*.mp4" 2>/dev/null | head -20 || true

      - name: Upload video outputs artifact
        uses: actions/upload-artifact@v4
        with:
          name: video-manim-outputs-${{ github.event.issue.number }}-${{ github.run_id }}
          path: |
            agents/video_manim/outputs/**
            agents/video_manim/media/videos/**
            outputs/manim/**
            media/videos/**
          if-no-files-found: warn
          retention-days: 14

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: video-manim-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 14

      - name: Comment artifact link
        if: always()
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "ğŸ¬ video_manim å·²æ‰§è¡Œå®Œæˆã€‚è¯·åœ¨æœ¬æ¬¡ workflow çš„ Artifacts æŸ¥çœ‹è§†é¢‘ä¸è„šæœ¬ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

  # ========== /command è§¦å‘ï¼ˆ/review, /quiet, /close, /confirm-closeï¼‰ ==========
  process-command:
    if: github.event_name == 'issue_comment' &&
        github.event.issue.state == 'open' &&
        (contains(github.event.comment.body, '/review') ||
         contains(github.event.comment.body, '/quiet') ||
         contains(github.event.comment.body, '/close') ||
         contains(github.event.comment.body, '/confirm-close')) &&
        !contains(github.event.comment.body, '@')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
      - run: uv sync

      - name: Extract command
        id: extract
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          COMMENT="$COMMENT_BODY"
          if echo "$COMMENT" | grep -q '/confirm-close'; then
            echo "command=/confirm-close" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/review'; then
            echo "command=/review" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/quiet'; then
            echo "command=/quiet" >> $GITHUB_OUTPUT
          elif echo "$COMMENT" | grep -q '/close'; then
            echo "command=/close" >> $GITHUB_OUTPUT
          fi

      - name: Handle quiet command
        if: steps.extract.outputs.command == '/quiet'
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:quiet" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Request close confirmation
        if: steps.extract.outputs.command == '/close'
        run: |
          echo "[INFO] æ”¶åˆ°å…³é—­ Issue è¯·æ±‚ï¼Œéœ€è¦ç¡®è®¤..."
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:pending-close" \
            --repo ${{ github.repository }}
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body - <<-EOF
            ## å…³é—­ç¡®è®¤

            æ­¤ Issue å³å°†è¢«å…³é—­ã€‚è¯·å›å¤ **/confirm-close** ä»¥ç¡®è®¤å…³é—­ï¼Œæˆ–ä»»æ„å›å¤ä»¥å–æ¶ˆã€‚

            > ç”± @${{ github.event.comment.user.login }} å‘èµ·å…³é—­è¯·æ±‚
            EOF
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Confirm and close issue
        if: steps.extract.outputs.command == '/confirm-close'
        run: |
          echo "[OK] ç¡®è®¤å…³é—­ Issue..."
          gh issue edit ${{ github.event.issue.number }} \
            --remove-label "bot:pending-close" \
            --repo ${{ github.repository }}
          gh issue close ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --reason "completed"
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "[OK] Issue å·²ç”± @${{ github.event.comment.user.login }} æ‰‹åŠ¨å…³é—­"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Run review process
        if: steps.extract.outputs.command == '/review'
        run: |
          echo "Running /review command..."
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "state:review" \
            --repo ${{ github.repository }}
          uv run python -m issuelab review \
            --issue ${{ github.event.issue.number }} \
            --post
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "bot:needs-summary" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
          LOG_FILE: ${{ github.workspace }}/logs/review_${{ github.event.issue.number }}.log
          LOG_LEVEL: DEBUG
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "30000"
          ACTIONS_STEP_DEBUG: "true"
          ACTIONS_RUNNER_DEBUG: "true"

      - uses: actions/upload-artifact@v4
        with:
          name: command-logs-${{ github.event.issue.number }}
          path: logs/
          retention-days: 7

  observability-summary:
    if: always()
    needs:
      - auto-trigger-review
      - detect-mentions
      - run-moderator
      - run-reviewer_a
      - run-reviewer_b
      - run-summarizer
      - run-pubmed-observer
      - run-arxiv-observer
      - run-observer
      - run-video-manim
      - process-command
    runs-on: ubuntu-latest
    steps:
      - name: Emit observability summary
        env:
          WF_NAME: ${{ github.workflow }}
          JOB_NAME: observability-summary
          RUN_ID: ${{ github.run_id }}
          REPO_NAME: ${{ github.repository }}
          SHA: ${{ github.sha }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          NEEDS_JSON: ${{ toJson(needs) }}
          SYSTEM_AGENTS: ${{ needs.detect-mentions.outputs.agents }}
          HAS_SYSTEM: ${{ needs.detect-mentions.outputs.has_system }}
        run: |
          set -euo pipefail
          mkdir -p artifacts/observability

          python - << 'PY'
          import json
          import os
          from collections import Counter
          from datetime import UTC, datetime
          from pathlib import Path

          needs = json.loads(os.getenv("NEEDS_JSON") or "{}")
          results = {}
          for job, payload in needs.items():
            if isinstance(payload, dict):
              results[job] = str(payload.get("result", "unknown"))
            else:
              results[job] = "unknown"

          success_count = sum(1 for r in results.values() if r == "success")
          failed_count = sum(1 for r in results.values() if r == "failure")
          skipped_count = sum(1 for r in results.values() if r == "skipped")
          input_count = len([j for j in results.keys() if j != "observability-summary"])

          failures = Counter()
          for job, result in results.items():
            if result == "failure":
              failures[f"JOB_FAILED:{job}"] += 1
            elif result == "cancelled":
              failures[f"JOB_CANCELLED:{job}"] += 1

          failures_topn = [{"code": k, "count": v, "samples": []} for k, v in failures.most_common(8)]
          status = "success"
          if failed_count > 0 and success_count > 0:
            status = "partial"
          elif failed_count > 0 and success_count == 0:
            status = "failure"
          elif success_count == 0 and skipped_count > 0:
            status = "skipped"

          payload = {
            "schema_version": "v1",
            "workflow": os.getenv("WF_NAME"),
            "job": os.getenv("JOB_NAME"),
            "run_id": os.getenv("RUN_ID"),
            "repo": os.getenv("REPO_NAME"),
            "sha": os.getenv("SHA"),
            "issue_number": os.getenv("ISSUE_NUMBER"),
            "finished_at": datetime.now(UTC).isoformat().replace("+00:00", "Z"),
            "metrics": {
              "input_count": input_count,
              "success_count": success_count,
              "failed_count": failed_count,
              "skipped_count": skipped_count,
            },
            "context": {
              "has_system_mentions": os.getenv("HAS_SYSTEM") or "",
              "system_agents": os.getenv("SYSTEM_AGENTS") or "",
              "job_results": results,
            },
            "failures_topn": failures_topn,
            "status": status,
          }

          Path("artifacts/observability/orchestrator__summary.json").write_text(
            json.dumps(payload, ensure_ascii=False, indent=2), encoding="utf-8"
          )

          summary = [
            "## Observability (orchestrator summary)",
            "",
            "| metric | value |",
            "|---|---:|",
            f"| input_count | {input_count} |",
            f"| success_count | {success_count} |",
            f"| failed_count | {failed_count} |",
            f"| skipped_count | {skipped_count} |",
            f"| status | {status} |",
            "",
            "### Failure TopN",
          ]
          if failures_topn:
            for item in failures_topn:
              summary.append(f"- `{item['code']}`: {item['count']}")
          else:
            summary.append("- none")

          with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as f:
            f.write("\n".join(summary) + "\n")
          PY

      - name: Upload observability artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: orchestrator-observability-${{ github.event.issue.number }}-${{ github.run_id }}
          path: artifacts/observability/
          retention-days: 14
