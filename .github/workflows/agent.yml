name: Run Agent on Dispatch

on:
  repository_dispatch:
    types: [agent_trigger]

permissions:
  contents: read
  issues: write

jobs:
  run-agent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync

      - name: Get agent name
        id: agent
        run: |
          # ä»ä»“åº“åæå– agent åç§°ï¼ˆå¦‚ gqy22/IssueLab -> gqy22ï¼‰
          agent="${GITHUB_REPOSITORY%/*}"
          echo "name=$agent" >> $GITHUB_OUTPUT
          echo "ğŸ¤– Agent: $agent"

      - name: Run agent
        run: |
          echo "ğŸš€ æ‰§è¡Œ agent: ${{ steps.agent.outputs.name }}"
          echo "ğŸ“ Source repo: ${{ github.event.client_payload.source_repo }}"
          echo "ğŸ“ Issue: ${{ github.event.client_payload.issue_number }}"

          mkdir -p ${{ github.workspace }}/logs

          # æ„å»º gh CLI éœ€è¦çš„ä»“åº“ URL
          source_repo="${{ github.event.client_payload.source_repo }}"

          # æ‰§è¡Œ agent
          GH_REPO="$source_repo" uv run python -m issuelab execute \
            --issue ${{ github.event.client_payload.issue_number }} \
            --agents "${{ steps.agent.outputs.name }}" \
            --post
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          LOG_FILE: ${{ github.workspace }}/logs/agent_${{ github.event.client_payload.issue_number }}.log
          LOG_LEVEL: DEBUG
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "30000"
          ACTIONS_STEP_DEBUG: "true"
          ACTIONS_RUNNER_DEBUG: "true"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-logs-${{ github.event.client_payload.issue_number }}-${{ github.run_id }}
          path: logs/
          retention-days: 7

      - name: Comment on failure
        if: failure()
        run: |
          source_repo="${{ github.event.client_payload.source_repo }}"
          GH_REPO="$source_repo" gh issue comment ${{ github.event.client_payload.issue_number }} \
            --body "âŒ Agent ${{ steps.agent.outputs.name }} execution failed. Check [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
