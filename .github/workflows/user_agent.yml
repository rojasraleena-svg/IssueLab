name: Run Agent on Workflow Dispatch

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (owner/repo)'
        required: true
        type: string
      issue_number:
        description: 'Issue number'
        required: true
        type: string
      issue_title:
        description: 'Issue title'
        required: false
        type: string
      issue_body:
        description: 'Issue body'
        required: false
        type: string
      comment_id:
        description: 'Comment ID'
        required: false
        type: string
      comment_body:
        description: 'Comment body'
        required: false
        type: string
      labels:
        description: 'Issue labels (JSON array)'
        required: false
        type: string
      target_username:
        description: 'Target agent username'
        required: false
        type: string
      available_agents:
        description: 'Available agents in the system (JSON array)'
        required: false
        type: string

permissions:
  contents: read
  issues: write

jobs:
  run-agent:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/run-user-agent

      - name: Extract agent username
        id: agent
        run: |
          # ä»ä»“åº“åæå–ç”¨æˆ·åï¼ˆå‡è®¾ä»“åº“åæ˜¯ username/IssueLabï¼‰
          username="${{ github.repository_owner }}"
          echo "username=$username" >> $GITHUB_OUTPUT
          echo "Agent username: $username"

      - name: Check agent config exists
        id: check
        run: |
          config_file="agents/${{ steps.agent.outputs.username }}/agent.yml"
          prompt_file="agents/${{ steps.agent.outputs.username }}/prompt.md"

          if [ ! -f "$config_file" ]; then
            echo "Error: Agent config not found: $config_file"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ ! -f "$prompt_file" ]; then
            echo "Error: Agent prompt not found: $prompt_file"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "exists=true" >> $GITHUB_OUTPUT
          echo "config_file=$config_file" >> $GITHUB_OUTPUT
          echo "prompt_file=$prompt_file" >> $GITHUB_OUTPUT

      - name: Sync dependencies
        if: steps.check.outputs.exists == 'true'
        run: uv sync

      - name: Check LLM API health
        if: steps.check.outputs.exists == 'true'
        id: api_health
        env:
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
        run: |
          set -euo pipefail

          if [ -z "${ANTHROPIC_AUTH_TOKEN:-}" ]; then
            echo "âŒ LLM API health check failed: ANTHROPIC_AUTH_TOKEN is empty"
            exit 1
          fi

          BASE_URL="${ANTHROPIC_BASE_URL%/}"
          MODEL="${ANTHROPIC_MODEL:-MiniMax-M2.1}"
          PROBE_URL="$BASE_URL/v1/messages"

          echo "Health check target: $PROBE_URL"

          HTTP_CODE=$(curl -sS -o /tmp/llm_health_body.txt -w "%{http_code}" \
            -X POST "$PROBE_URL" \
            -H "content-type: application/json" \
            -H "x-api-key: ${ANTHROPIC_AUTH_TOKEN}" \
            -H "anthropic-version: 2023-06-01" \
            --data "{\"model\":\"${MODEL}\",\"max_tokens\":1,\"messages\":[{\"role\":\"user\",\"content\":\"ping\"}]}" || echo "000")

          if [ "$HTTP_CODE" = "404" ] || [ "$HTTP_CODE" = "000" ]; then
            echo "âŒ LLM API health check failed: upstream unavailable or invalid endpoint"
            echo "base_url=${BASE_URL}"
            echo "probe_url=${PROBE_URL}"
            echo "http_code=${HTTP_CODE}"
            echo "response_preview:"
            sed -n '1,5p' /tmp/llm_health_body.txt || true
            exit 1
          fi

          echo "âœ… LLM API health check passed (http_code=${HTTP_CODE})"

      - name: Run agent
        if: steps.check.outputs.exists == 'true'
        id: run_agent
        env:
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.minimaxi.com/anthropic' }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'MiniMax-M2.1' }}
          # ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·PATï¼Œfallbackåˆ°é»˜è®¤token
          # é…ç½®PATåï¼Œå›å¤ä¼šæ˜¾ç¤ºç”¨æˆ·æœ¬äººè€Œébot
          # gh CLI ä¼šä¼˜å…ˆä½¿ç”¨ GH_TOKENï¼Œç„¶åæ˜¯ GITHUB_TOKEN
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          LOG_FILE: ${{ github.workspace }}/logs/user_agent_${{ inputs.issue_number }}.log
          LOG_LEVEL: DEBUG
          CLAUDE_AGENT_SDK_SKIP_VERSION_CHECK: "true"
          MCP_LOG_DETAIL: "1"
          PROMPT_LOG: "1"
          ISSUELAB_TRIGGER_COMMENT: ${{ inputs.comment_body }}
        run: |
          echo "Running agent for: ${{ steps.agent.outputs.username }}"
          echo "Source Issue: ${{ inputs.source_repo }}#${{ inputs.issue_number }}"

          uv run python -m issuelab personal-reply \
            --agent "${{ steps.agent.outputs.username }}" \
            --issue ${{ inputs.issue_number }} \
            --repo "${{ inputs.source_repo }}" \
            --issue-title "${{ inputs.issue_title }}" \
            --issue-body "${{ inputs.issue_body }}" \
            ${{ inputs.available_agents && format('--available-agents ''{0}''', inputs.available_agents) || '' }} \
            --post

          echo "Agent execution completed"

      # Fallback: å¦‚æœç”¨æˆ·æ²¡æœ‰é…ç½®PATæ— æ³•ç›´æ¥è¯„è®ºï¼Œå°†ç»“æœä¿å­˜å¹¶æç¤º
      - name: Save response for manual posting
        if: always() && steps.run_agent.outputs.comment_failed == 'true'
        run: |
          echo "âš ï¸ Agent executed successfully but couldn't post comment to main repo"
          echo "ğŸ“ Response saved in logs/user_agent_${{ inputs.issue_number }}.log"
          echo ""
          echo "ğŸ’¡ To enable auto-posting with your identity:"
          echo "1. Create a Personal Access Token (PAT) at https://github.com/settings/tokens"
          echo "2. Grant 'repo' and 'workflow' permissions"
          echo "3. Add as PERSONAL_GITHUB_TOKEN secret in your repository settings"
          echo ""
          echo "Benefits:"
          echo "- Comments show as YOU (not github-actions bot)"
          echo "- Can trigger other workflows with @mentions"
          echo "- Full cross-repo permissions"

      - uses: actions/upload-artifact@v4
        with:
          name: user-agent-logs-${{ inputs.issue_number }}-${{ github.run_id }}
          path: logs/
          retention-days: 7

      - name: Comment on config error
        if: failure() && steps.check.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = '${{ inputs.source_repo }}'.split('/');
            await github.rest.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: ${{ inputs.issue_number }},
              body: `âš ï¸ @${{ steps.agent.outputs.username }}'s agent configuration is missing or invalid. Please check your fork.`
            });

      - name: Comment on execution error
        if: failure() && steps.check.outputs.exists == 'true' && steps.api_health.outcome != 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = '${{ inputs.source_repo }}'.split('/');
            await github.rest.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: ${{ inputs.issue_number }},
              body: `âŒ @${{ steps.agent.outputs.username }}'s agent encountered an error. Please check the [Actions logs](https://github.com/${{ github.repository }}/actions).`
            });

      - name: Comment on API health error
        if: failure() && steps.check.outputs.exists == 'true' && steps.api_health.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = '${{ inputs.source_repo }}'.split('/');
            const timestamp = new Date().toISOString();
            await github.rest.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: ${{ inputs.issue_number }},
              body: `âŒ @${{ steps.agent.outputs.username }} çš„æ‰§è¡Œåœ¨ API å¥åº·æ£€æŸ¥é˜¶æ®µå¤±è´¥ï¼ˆ${timestamp}ï¼‰ã€‚\n\nåŸå› ï¼šä¸Šæ¸¸ LLM API ä¸å¯ç”¨æˆ–ç«¯ç‚¹é…ç½®é”™è¯¯ã€‚\nè¯·æ£€æŸ¥ fork ä»“åº“çš„ \`ANTHROPIC_BASE_URL\` / \`ANTHROPIC_AUTH_TOKEN\` é…ç½®ï¼Œå¹¶æŸ¥çœ‹ [Actions logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ã€‚`
            });

      - name: Emit observability summary
        if: always()
        env:
          WF_NAME: ${{ github.workflow }}
          JOB_NAME: run-agent
          RUN_ID: ${{ github.run_id }}
          REPO_NAME: ${{ github.repository }}
          SHA: ${{ github.sha }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          CHECK_EXISTS: ${{ steps.check.outputs.exists }}
          CHECK_OUTCOME: ${{ steps.check.outcome }}
          API_HEALTH_OUTCOME: ${{ steps.api_health.outcome }}
          RUN_AGENT_OUTCOME: ${{ steps.run_agent.outcome }}
          COMMENT_FAILED: ${{ steps.run_agent.outputs.comment_failed }}
        run: |
          set -euo pipefail
          mkdir -p artifacts/observability

          python - << 'PY'
          import json
          import os
          from datetime import UTC, datetime

          check_exists = (os.getenv("CHECK_EXISTS") or "") == "true"
          check_outcome = os.getenv("CHECK_OUTCOME") or ""
          api_outcome = os.getenv("API_HEALTH_OUTCOME") or ""
          run_outcome = os.getenv("RUN_AGENT_OUTCOME") or ""
          comment_failed = (os.getenv("COMMENT_FAILED") or "").lower() == "true"

          input_count = 1
          success_count = 1 if run_outcome == "success" else 0
          failed_count = 0 if success_count == 1 else 1
          skipped_count = 0

          failures = []
          if check_outcome == "failure" or not check_exists:
            failures.append({"code": "CONFIG_MISSING", "count": 1, "samples": []})
          elif api_outcome == "failure":
            failures.append({"code": "API_UNAVAILABLE", "count": 1, "samples": []})
          elif run_outcome == "failure":
            failures.append({"code": "AGENT_EXECUTION_FAILED", "count": 1, "samples": []})
          if comment_failed:
            failures.append({"code": "COMMENT_POST_FAILED", "count": 1, "samples": []})

          status = "success"
          if failed_count > 0 and success_count > 0:
            status = "partial"
          elif failed_count > 0 and success_count == 0:
            status = "failure"

          payload = {
            "schema_version": "v1",
            "workflow": os.getenv("WF_NAME"),
            "job": os.getenv("JOB_NAME"),
            "run_id": os.getenv("RUN_ID"),
            "repo": os.getenv("REPO_NAME"),
            "sha": os.getenv("SHA"),
            "issue_number": os.getenv("ISSUE_NUMBER"),
            "finished_at": datetime.now(UTC).isoformat().replace("+00:00", "Z"),
            "metrics": {
              "input_count": input_count,
              "success_count": success_count,
              "failed_count": failed_count,
              "skipped_count": skipped_count,
            },
            "failures_topn": failures[:5],
            "status": status,
          }

          with open("artifacts/observability/user_agent__run-agent.json", "w", encoding="utf-8") as fh:
            json.dump(payload, fh, ensure_ascii=False, indent=2)

          summary = [
            "## Observability (run-agent)",
            "",
            "| metric | value |",
            "|---|---:|",
            f"| input_count | {input_count} |",
            f"| success_count | {success_count} |",
            f"| failed_count | {failed_count} |",
            f"| skipped_count | {skipped_count} |",
            f"| status | {status} |",
            "",
            "### Failure TopN",
          ]
          if failures:
            for item in failures:
              summary.append(f"- `{item['code']}`: {item['count']}")
          else:
            summary.append("- none")

          with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as f:
            f.write("\n".join(summary) + "\n")
          PY

      - name: Upload observability artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: user-agent-observability-${{ inputs.issue_number }}-${{ github.run_id }}
          path: artifacts/observability/
          retention-days: 14
